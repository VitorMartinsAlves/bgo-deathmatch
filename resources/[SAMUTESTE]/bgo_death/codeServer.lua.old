local deadPlayer = {}
local state = false
local AccidentBlip = {}
local createdeadPed = {}
local animTimer = {}

local weaponID = {
	44,
	45,
	46,
	47,
	48,
	49,
	50,
	51,
	52,
	53,
	68,
	103,
	128,
}

addEventHandler('onPlayerWasted', root, function(ammo, attacker, weapon, bodypart)
	if bodypart == 9 then 
		if weapon ~= 23 then 
			setElementData(source, 'dead.info', 9 )
		end
	end
	 if not isPedInVehicle(source) then
		 createPedToPlayer(source)
	 end
end)

local tempo = { }
function createPedToPlayer(element)
	local player = element
	if isElement(createdeadPed[player]) then 
		destroyElement(createdeadPed[player])
		createdeadPed[player] = false
	end
	 if not createdeadPed[player] then 
		outputDebugString('Criado!!')
		local skin = getElementModel(player)
		local x, y, z = getElementPosition(player)

		local rot = getPedRotation(player)
		createdeadPed[player] = createPed(skin, x, y, z, rot)
		setElementAlpha(createdeadPed[player], 0)
		--setElementData(createdeadPed[player], 'Ped:Name', " ")
		setElementHealth(createdeadPed[player], 1)
		setElementData(createdeadPed[player], 'ammoInBody', getElementData(player, 'ammoInBody'))
		setElementData(createdeadPed[player], 'dead.info', getElementData(player, 'dead.info'))
		setElementData(createdeadPed[player], 'owner->element', player)
		setElementData(createdeadPed[player], 'deadped', true)
		setElementData(player, 'PlayerCaido', true)
		exports.bgo_voice:setPlayerChannel ( player, math.random(1000,9999999) )
		setPlayerVoiceIgnoreFrom ( player, root)

		
		setPedAnimation(player, "ped", "FLOOR_hit", -1, false, false, false)
		setPedAnimation(createdeadPed[player], "ped", "FLOOR_hit_f", -1, false, false, true)
		attachElements(createdeadPed[player], player)
	 end
end
addEvent('bgoMTA->#createPedToPlayer', true)
addEventHandler('bgoMTA->#createPedToPlayer', root, createPedToPlayer)

function setPlayerAnimation(player, animName, animtoName, animTime, loop)
	setPedAnimation(player, animName, animtoName, animTime, loop, false, false)
end
addEvent('bgoMTA->#setPlayerAnimation', true)
addEventHandler('bgoMTA->#setPlayerAnimation', root, setPlayerAnimation)

addEvent('bgoMTA->#killPed', true)
addEventHandler('bgoMTA->#killPed', root, function(player)
	setElementHealth(player, 0)
end)

addEvent('bgoMTA->#destroyBlipS', true)
addEventHandler('bgoMTA->#destroyBlipS', root, function(marker)
	-- setElementHealth(player, 0)
	triggerClientEvent(root, 'bgoMTA->#destroyBlip', root)
end)

addEvent('bgoMTA->#spawnPed', true)
addEventHandler('bgoMTA->#spawnPed', root, function(player)
	local skin = getElementModel(player)
	local x, y, z, rot = 815.71533203125,-1096.6566162109,25.790239334106
	setElementData(player , 'char:hunger' , 20)
	setElementData(player , 'char:thirst' , 20)
	
	if isTimer(tempo[player]) then
	killTimer(tempo[player])
	end
	
	spawnPlayer(player, x, y, z, rot, skin, 0, 0)
	setElementHealth ( player, 100 )
	setElementData(player,"char:moneysujo", 0)


	setPlayerVoiceIgnoreFrom ( player, player)

	local empty = exports.bgo_voice:getNextEmptyChannel() 
	exports.bgo_voice:setPlayerChannel(player, empty)  

	setElementData(player, 'PlayerCaido', false)
	setElementData(player, "char:money", getElementData(player, "char:money") - (math.floor(getElementData(player, "char:money")/2)))



	if exports['bgo_items']:hasItemS(player, 38) then 
	exports['bgo_items']:takePlayerItemToID(player, 38, 0)
	end
	if exports['bgo_items']:hasItemS(player, 32) then 
	exports['bgo_items']:takePlayerItemToID(player, 32, 0)
	end
	if exports['bgo_items']:hasItemS(player, 47) then 
		exports['bgo_items']:takePlayerItemToID(player, 47, 0)
	end
	if exports['bgo_items']:hasItemS(player, 64) then 
	exports['bgo_items']:takePlayerItemToID(player, 64, 0)
	end
	if exports['bgo_items']:hasItemS(player, 84) then 
	exports['bgo_items']:takePlayerItemToID(player, 84, 0)
	end
	if exports['bgo_items']:hasItemS(player, 52) then 
	exports['bgo_items']:takePlayerItemToID(player, 52, 0)
	end
	if exports['bgo_items']:hasItemS(player, 50) then 
	exports['bgo_items']:takePlayerItemToID(player, 50, 0)
	end
	if exports['bgo_items']:hasItemS(player, 49) then 
	exports['bgo_items']:takePlayerItemToID(player, 49, 0)
	end
	if exports['bgo_items']:hasItemS(player, 44) then 
	exports['bgo_items']:takePlayerItemToID(player, 44, 0)
	end
	if exports['bgo_items']:hasItemS(player, 51) then 
	exports['bgo_items']:takePlayerItemToID(player, 51, 0)
	end
	if exports['bgo_items']:hasItemS(player, 53) then 
	exports['bgo_items']:takePlayerItemToID(player, 53, 0)
	end
	if exports['bgo_items']:hasItemS(player, 44) then 
	exports['bgo_items']:takePlayerItemToID(player, 44, 0)
	end		
	if exports['bgo_items']:hasItemS(player, 68) then 
	exports['bgo_items']:takePlayerItemToID(player, 68, 0)
	end		
	if exports['bgo_items']:hasItemS(player, 125) then 
	exports['bgo_items']:takePlayerItemToID(player, 125, 0)
	end		
	if exports['bgo_items']:hasItemS(player, 128) then 
	exports['bgo_items']:takePlayerItemToID(player, 128, 0)
	end	
	if exports['bgo_items']:hasItemS(player, 103) then 
	exports['bgo_items']:takePlayerItemToID(player, 103, 0)
	end	


	if not exports.serialVip:isPlayerVip(player) then

	if exports['bgo_items']:hasItemS(player, 68) then 
	exports['bgo_items']:takePlayerItemToID(player, 68, 0)
	end
	if exports['bgo_items']:hasItemS(player, 103) then 
		exports['bgo_items']:takePlayerItemToID(player, 103, 0)
	end

	 if exports['bgo_items']:hasItemS(player, 116) then 
	 exports['bgo_items']:takePlayerItemToID(player, 116, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 117) then 
	 exports['bgo_items']:takePlayerItemToID(player, 117, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 118) then 
	 exports['bgo_items']:takePlayerItemToID(player, 118, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 119) then 
	 exports['bgo_items']:takePlayerItemToID(player, 119, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 120) then 
	 exports['bgo_items']:takePlayerItemToID(player, 120, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 121) then 
	 exports['bgo_items']:takePlayerItemToID(player, 121, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 122) then 
	 exports['bgo_items']:takePlayerItemToID(player, 122, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 123) then 
	 exports['bgo_items']:takePlayerItemToID(player, 123, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 124) then 
	 exports['bgo_items']:takePlayerItemToID(player, 124, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 125) then 
	 exports['bgo_items']:takePlayerItemToID(player, 125, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 126) then 
	 exports['bgo_items']:takePlayerItemToID(player, 126, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 127) then 
	 exports['bgo_items']:takePlayerItemToID(player, 127, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 128) then 
	 exports['bgo_items']:takePlayerItemToID(player, 128, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 129) then 
	 exports['bgo_items']:takePlayerItemToID(player, 129, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 130) then 
	 exports['bgo_items']:takePlayerItemToID(player, 130, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 131) then 
	 exports['bgo_items']:takePlayerItemToID(player, 131, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 132) then 
	 exports['bgo_items']:takePlayerItemToID(player, 132, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 133) then 
	 exports['bgo_items']:takePlayerItemToID(player, 133, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 134) then 
	 exports['bgo_items']:takePlayerItemToID(player, 134, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 135) then 
	 exports['bgo_items']:takePlayerItemToID(player, 135, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 220) then 
	 exports['bgo_items']:takePlayerItemToID(player, 220, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 221) then 
	 exports['bgo_items']:takePlayerItemToID(player, 221, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 222) then 
	 exports['bgo_items']:takePlayerItemToID(player, 222, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 223) then 
	 exports['bgo_items']:takePlayerItemToID(player, 223, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 224) then 
	 exports['bgo_items']:takePlayerItemToID(player, 224, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 225) then 
	 exports['bgo_items']:takePlayerItemToID(player, 225, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 226) then 
	 exports['bgo_items']:takePlayerItemToID(player, 226, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 241) then 
	 exports['bgo_items']:takePlayerItemToID(player, 241, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 242) then 
	 exports['bgo_items']:takePlayerItemToID(player, 242, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 243) then 
	 exports['bgo_items']:takePlayerItemToID(player, 243, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 244) then 
	 exports['bgo_items']:takePlayerItemToID(player, 244, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 245) then 
	 exports['bgo_items']:takePlayerItemToID(player, 245, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 246) then 
	 exports['bgo_items']:takePlayerItemToID(player, 246, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 247) then 
	 exports['bgo_items']:takePlayerItemToID(player, 247, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 248) then 
	 exports['bgo_items']:takePlayerItemToID(player, 248, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 265) then 
	 exports['bgo_items']:takePlayerItemToID(player, 265, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 266) then 
	 exports['bgo_items']:takePlayerItemToID(player, 266, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 267) then 
	 exports['bgo_items']:takePlayerItemToID(player, 267, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 283) then 
	 exports['bgo_items']:takePlayerItemToID(player, 283, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 284) then 
	 exports['bgo_items']:takePlayerItemToID(player, 284, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 285) then 
	 exports['bgo_items']:takePlayerItemToID(player, 285, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 286) then 
	 exports['bgo_items']:takePlayerItemToID(player, 286, 0)
	 end
	 if exports['bgo_items']:hasItemS(player, 287) then 
		exports['bgo_items']:takePlayerItemToID(player, 287, 0)
	 end
	 end




end)

addEvent('bgoMTA->#startPlaySound', true)
addEventHandler('bgoMTA->#startPlaySound', root, function(vehicle, state)
	triggerClientEvent(root, 'bgoMTA->#playSound', vehicle, state)
end)

addEvent("bgoMTA->#openDoor", true)
addEventHandler("bgoMTA->#openDoor", root, function(vehicle, door)
	if getVehicleDoorOpenRatio(vehicle, door) == 0 then
		setVehicleDoorOpenRatio(vehicle, door, 1, 800)
	else
		setVehicleDoorOpenRatio(vehicle, door, 0, 800)
	end
end)

addEvent("bgoMTA->#stopEngine", true)
addEventHandler("bgoMTA->#stopEngine", root, function(vehicle)
	setVehicleEngineState(vehicle, false)
	setElementData(vehicle, "engine", 0, false)
end)

addEvent("bgoMTA->#messagetoFireman", true)
addEventHandler("bgoMTA->#messagetoFireman", root, function(player, ID)
	if not state then 
		--exports["bgo_groups"]:SendMessageToTeam (ID, "#D75656[bombeiros]: #ffffffUm acidente aconteceu com urgência na Cidade! #F7CA18Enviamos as coordenadas no radar!", 231, 217, 176,true)
		triggerClientEvent(root, 'bgoMTA->#createMarkerAndBlip', player)
		state = true
		setTimer(function() state = false end, 300, 1)
	end
end)

addEvent("bgoMTA->#setFrozen", true)
addEventHandler("bgoMTA->#setFrozen", root, function(vehicle, state)
	setElementFrozen(vehicle, state)
	if not state then 
		setElementData(vehicle, 'car->stuck', false)
	end
end)

addEvent("bgoMTA->#setVisible", true)
addEventHandler("bgoMTA->#setVisible", root, function(vehicle, doorNumber)
	setVehicleLocked(vehicle, false)
	setVehicleDoorState (vehicle, doorNumber, 4)
	setElementData(vehicle, 'car->stuckDoor' ..doorNumber, false)
end)

addEvent("bgoMTA->#removePlayerVehicle", true)
addEventHandler("bgoMTA->#removePlayerVehicle", root, function(player, warpedPlayer)
	  local x,y,z = getElementPosition(warpedPlayer)
	  setElementPosition(player, x,y,z)
	  removePlayerFromVehicle(player)
	  setElementData(player, 'char->stuck', false)
	  setPlayerAnimation(player, "BEACH", "ParkSit_M_loop", 1, true)
	  createPedToPlayer(player)
end)

addEvent("bgoMTA->#removePlayerToVehicle", true)
addEventHandler("bgoMTA->#removePlayerToVehicle", root, function(player, warpedPlayer)
	removePlayerFromVehicle(player)
	setTimer(function()
		createPedToPlayer(player)
	end, 100, 1)
end)

addEventHandler( "onPlayerSpawn", getRootElement(), function()
	if isElement(createdeadPed[source]) then
		detachElements ( createdeadPed[source] )
		local x, y, z = getElementPosition(source)

	if isTimer(tempo[source]) then
	killTimer(tempo[source])
	end


		setPlayerVoiceIgnoreFrom ( source, source)
		local empty = exports.bgo_voice:getNextEmptyChannel() 
		exports.bgo_voice:setPlayerChannel(source, empty)  

		setElementData(source, 'PlayerCaido', false)

		setElementPosition(source, x, y, z+1)
		setTimer(function(source)
			destroyElement(createdeadPed[source])
		end, 100, 1, source)
	end	
end)

addEventHandler( "onPlayerQuit", getRootElement(), function()
	if isElement(createdeadPed[source]) then 
		setTimer(function(source)
			detachElements ( createdeadPed[source] )
			destroyElement(createdeadPed[source])
		end, 100, 1, source)
	end	
end)

function logMe( message )

	local logMeBuffer = getElementData(getRootElement(), "killog") or { }

	local r = getRealTime()

	exports.global:sendMessageToAdmins(message)

	table.insert(logMeBuffer,"["..("%02d:%02d"):format(r.hour,r.minute).. "] " ..  message)

	if #logMeBuffer > 30 then
		table.remove(logMeBuffer, 1)
	end
	setElementData(getRootElement(), "killog", logMeBuffer)

end

function startBleeding(attacker, weapon, bodypart)

	local health = getElementHealth(source)

	local bleeding = getElementData(source, "bleeding")

	

	if (health<=20) and (health>0) and (bleeding~=1) then

		setElementData(source, "bleeding", 1, false)

		--exports.global:sendLocalMeAction(source, "começou a sangrar.")

		setTimer(bleedPlayer, 3000, 1, source, getPlayerName(source))

	end

end

--addEventHandler("onPlayerDamage", getRootElement(), startBleeding)



function bleedPlayer(thePlayer, playerName)

	if (isElement(thePlayer)) then -- still logged in & playing

		if (playerName==getPlayerName(thePlayer)) then -- make sure they havent changed character

			local health = getElementHealth(thePlayer)

			

			if (health<=20) and (health>0) then

				setElementHealth(thePlayer, health-2)

				setTimer(bleedPlayer, 60000, 1, thePlayer, playerName)

			else

				setElementData(thePlayer, "bleeding", 0, false)

			end

		end

	end

end





local playerInjuries = {} -- create a table to save the injuries



function copy( t )

	local r = {}

	if type(t) == 'table' then

		for k, v in pairs( t ) do

			r[k] = v

		end

	end

	return r

end



function isMelee( weapon )

	return weapon and weapon <= 15

end



function killknockedout(source)

	setElementHealth(source, 0)

end



function knockout()

	if playerInjuries[source] and not isTimer( playerInjuries[source]['knockout'] ) then

	--	outputChatBox("#7CC576[Információ] #ffffffElvesztetted az eszméleted!", source, 255, 0, 0,true)

		exports['bgo_info']:createDebugNotification(source, "Você perdeu sua consciência!", "error")

		toggleAllControls(source, false, true, false)

		

		fadeCamera(source, false, 120)

		playerInjuries[source]['knockout'] = setTimer(killknockedout, 120000, 1, source)

		
		setPedAnimation( source, "CRACK", "crckidle2", -1, true, false, true)
		--setPedAnimation( source, "CRACK", "crckidle2", -1, true, false, true)

		setElementData(source, "injuriedanimation", true)

	end

end



function injuries(attacker, weapon, bodypart, loss)

	if not loss or loss < 0.5 then

		return

	end

	-- if weapon == 23 then 
		-- setElementHealth(source, getElementHealth(source) + loss) 
	-- end

	-- drowning

	if weapon == 53 then

		return

	end

	

	-- source = player who was hit

	if not bodypart and getPedOccupiedVehicle(source) then

		bodypart = 3

	end

	

	-- BODY ARMOR

	if ( bodypart == 3 or bodypart == 9 ) and getPedArmor(source) > 0 then -- GOT (torso/head) PROTECTION?

		cancelEvent()

		return

	end



	-- katana kill

	if weapon == 8 then

		setPedHeadless(source, true)

		killPed(source, attacker, weapon, bodypart)

		return

	end



	-- 2% chance of melee knockout

	if isMelee( weapon ) then

		if math.random( 1, 50 ) == 1 then

			--knockout()

		end

		return

	end

	

	-- if we have injuries saved for the player, we add it to their table

	local injuredBefore = copy( playerInjuries[source] )

	if playerInjuries[source] then

		playerInjuries[source][bodypart] = true

	else

		-- create a new table for that player

		playerInjuries[source] = { [bodypart] = true } -- table

	end

	

	if ( bodypart == 3 and loss >= 15 ) or bodypart == 7 or bodypart == 8 then -- damaged either left or right leg

		if bodypart == 3 then

			bodypart = math.random( 7, 8 )

			if not injuredBefore[bodypart] then

--				outputChatBox("#ffffff[#7CC576bgo #ffffff- #FFA700Death#ffffff] Eltörted a #D75656" .. ( bodypart == 7 and "bal" or "jobb" ) .. " #fffffflábad!", source, 255, 0, 0,true)

			    exports['bgo_info']:createDebugNotification(source, "Você quebrou um " .. ( bodypart == 7 and "esquerda" or "direito" ) .. " seus pés!", "error")
				
				setElementData(source, 'injured', true)

			end

			playerInjuries[source][bodypart] = true

		elseif not injuredBefore[bodypart] then

--			outputChatBox("#ffffff[#7CC576bgo #ffffff- #FFA700Death#ffffff] Megütötted a #D75656" .. ( bodypart == 7 and "bal" or "jobb" ) .. " #fffffflábad!", source, 255, 0, 0,true)

			exports['bgo_info']:createDebugNotification(source, "Você acertou o " .. ( bodypart == 7 and "esquerda" or "direito" ) .. " seus pés!", 1)
			
			setElementData(source, 'injured', true)

		end



		if playerInjuries[source][7] and playerInjuries[source][8] then -- both were already hit

			toggleControl(source, 'forwards', false) -- disable walking forwards for the player who was hit

			toggleControl(source, 'left', false)

			toggleControl(source, 'right', false)

			toggleControl(source, 'backwards', false)

			toggleControl(source, 'enter_passenger', false)

			toggleControl(source, 'enter_exit', false)
			
			setElementData(source, 'injured', true)
		end

		

		-- we can be sure at least one of the legs was hit here, since we checked it above

		toggleControl(source, 'sprint', false) -- disable running forwards for the player who was hit

		toggleControl(source, 'jump', false) -- tried jumping with broken legs yet?

	elseif bodypart == 5 or bodypart == 6 then -- damaged either arm

		if playerInjuries[source][5] and playerInjuries[source][6] then -- both were already hit

			toggleControl(source, 'fire', false) -- disable firing weapons for the player who was hit

		end



		toggleControl(source, 'aim_weapon', false) -- disable aiming for the player who was hit (can still fire, but without crosshair)

		toggleControl(source, 'jump', false) -- can't climb over the wall with a broken arm

		setElementData(source, 'injured', true)
		
				
--		outputChatBox("#ffffff[#7CC576bgo #ffffff- #FFA700Death#ffffff] Megütötted a #D75656" .. ( bodypart == 5 and "bal" or "jobb" ) .. " #ffffffkezed!", source, 255, 0, 0,true)

		exports['bgo_info']:createDebugNotification(source, "Você acertou o " .. ( bodypart == 5 and "esquerda" or "direito" ) .. " sua mão!", "error")

	elseif bodypart == 9 then -- headshot

		if not attacker or weapon ~= 23 or getElementData(attacker, "deaglemode") ~= 0 then
			
			setPedHeadless(source, true)

			killPed(source, attacker, weapon, bodypart)

			return

		end

	end

	

	--if ( getElementHealth(source) < 20 or ( isElement( attacker ) and getElementType( attacker ) == "vehicle" and getElementHealth(source) < 40 ) ) and math.random( 1, 3 ) <= 2 then

	--	knockout()

	--end

end

function getPlayerInjured(player)
	if playerInjuries[player] and (playerInjuries[player][5] or playerInjuries[player][6]) then 
		return true
	end
	return false
end
addEvent('bgoMTA->#getPlayerInjured', true)
addEventHandler('bgoMTA->#getPlayerInjured', root, getPlayerInjured)


--addEventHandler( "onPlayerDamage", getRootElement(), injuries )

addCommandHandler( "fakeinjury",

	function(thePlayer, command, weapon, bodypart, loss)

		if exports.global:isPlayerAdmin(thePlayer) then

			source = thePlayer

			loss = tonumber(loss)

			setElementHealth(thePlayer, math.max(0, getElementHealth(thePlayer) - loss))

			injuries(nil, tonumber(weapon), tonumber(bodypart), loss)

		end

	end

)



function stabilize()
	if playerInjuries[source] and not isPedHeadless(source) then
		if playerInjuries[source]['knockout'] then

			setElementData(source, "injuriedanimation")

			if isTimer(playerInjuries[source]['knockout']) then

				killTimer(playerInjuries[source]['knockout'])

				playerInjuries[source]['knockout'] = nil

				

				fadeCamera(source, true, 2)

				setPedAnimation(source)

				--setPedAnimation(source)
				setPedAnimation(source)


				toggleControl(source, 'forwards', true)

				toggleControl(source, 'left', true)

				toggleControl(source, 'right', true)

				toggleControl(source, 'backwards', true)

				toggleControl(source, 'enter_passenger', true)

				setElementHealth(source, math.max( 20, getElementHealth(source) ) )

			end

		end

		

		if playerInjuries[source][7] and playerInjuries[source][8] then

			toggleControl(source, 'forwards', true)

			toggleControl(source, 'left', true)

			toggleControl(source, 'right', true)

			toggleControl(source, 'backwards', true)

			toggleControl(source, 'enter_passenger', true)

		end

	end

end



addEvent( "onPlayerStabilize", false )

addEventHandler( "onPlayerStabilize", getRootElement(), stabilize )



function examine(to)

	local name = getPlayerName(source):gsub("_", " ")

	if isPedDead(source) then

	--	outputChatBox(name .. " halott.", to, 255, 0, 0)

	elseif playerInjuries[source] and not isPedHeadless(source) then

		if playerInjuries[source]['knockout'] then

	--		outputChatBox(name.. " kiütve.", to, 255, 255, 0)

		end



		if playerInjuries[source][7] and playerInjuries[source][8] then

	--		outputChatBox("Mindkét lába " .. name .. "-nak/nek el van törve.", to, 255, 255, 0)

		elseif playerInjuries[source][7] then

	--		outputChatBox(name .. "bal lába el van törve.", to, 255, 255, 0)

		elseif playerInjuries[source][8] then

	--		outputChatBox(name .. " jobb lába el van törve.", to, 255, 255, 0)

		end



		if playerInjuries[source][5] and playerInjuries[source][6] then

	--		outputChatBox("Mindkét keze " .. name .. "-nak/nek el van törve.", to, 255, 255, 0)

		elseif playerInjuries[source][5] then

	--		outputChatBox(name .. " bal keze el van törve.", to, 255, 255, 0)

		elseif playerInjuries[source][6] then

	--		outputChatBox(name .. " jobb keze el van törve.", to, 255, 255, 0)

		end

	else

	--	outputChatBox(name .. " nincs megsérülve.", to, 255, 255, 0)

	end

end



addEvent( "onPlayerExamine", false )

addEventHandler( "onPlayerExamine", getRootElement(), examine )



function healInjuries(healed)

	if playerInjuries[source] and not isPedHeadless(source) then

		if playerInjuries[source]['knockout'] then

			setElementData(source, "injuriedanimation")

			if isTimer(playerInjuries[source]['knockout']) then

				killTimer(playerInjuries[source]['knockout'])

				playerInjuries[source]['knockout'] = nil

				

				if healed then

					fadeCamera(source, true, 2)

					setPedAnimation(source)

					setPedAnimation(source)

				end

			end

			toggleAllControls(source, true, true, false)

		else

			if playerInjuries[source][7] and playerInjuries[source][8] then

				toggleControl(source, 'forwards', true) -- disable walking forwards for the player who was hit

				toggleControl(source, 'left', true)

				toggleControl(source, 'right', true)

				toggleControl(source, 'backwards', true)

				toggleControl(source, 'enter_passenger', true)

				toggleControl(source, 'enter_exit', true)

			end

			if playerInjuries[source][7] or playerInjuries[source][8] then

				toggleControl(source, 'sprint', true)

				toggleControl(source, 'jump', true)

			end

			

			if playerInjuries[source][5] and playerInjuries[source][6] then

				toggleControl(source, 'fire', true)

			end

			if playerInjuries[source][5] or playerInjuries[source][6] then

				toggleControl(source, 'aim_weapon', true)

				toggleControl(source, 'jump', true)

			end

		end

		playerInjuries[source] = nil

	end

end



addEvent( "onPlayerHeal", false ) -- add a new event for it (called from /heal)

addEventHandler( "onPlayerHeal", getRootElement(), healInjuries)



function restoreInjuries( )

	if playerInjuries[source] and not isPedHeadless(source) then

		if playerInjuries[source][7] and playerInjuries[source][8] then

			toggleControl(source, 'forwards', false)

			toggleControl(source, 'left', false)

			toggleControl(source, 'right', false)

			toggleControl(source, 'backwards', false)

			toggleControl(source, 'enter_passenger', false)

			toggleControl(source, 'enter_exit', false)

		end

		if playerInjuries[source][7] or playerInjuries[source][8] then

			toggleControl(source, 'sprint', false)

			toggleControl(source, 'jump', false)

		end

		

		if playerInjuries[source][5] and playerInjuries[source][6] then

			toggleControl(source, 'fire', false)

		end

		if playerInjuries[source][5] or playerInjuries[source][6] then

			toggleControl(source, 'aim_weapon', false)

			toggleControl(source, 'jump', false)

		end

	end

end

addEventHandler( "onPlayerStopAnimation", getRootElement(), restoreInjuries )



function resetInjuries() -- it actually has some parameters, but we only need source right now - the wiki explains them though

	setPedHeadless(source, false)



	if playerInjuries[source] then

		-- reset injuries

		healInjuries()

	end

end



addEventHandler( "onPlayerSpawn", getRootElement(), resetInjuries) -- make sure old injuries don't carry over

addEventHandler( "onPlayerQuit", getRootElement(), resetInjuries) -- cleanup when the player quits
