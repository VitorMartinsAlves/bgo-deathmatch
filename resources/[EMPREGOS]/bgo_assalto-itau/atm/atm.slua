local ATM_PROGRESS_TIME = 300000
local ATM_TIMEOUT = 7200000
local ATM_PICKUPS = 1
local ATM_ROB_PAY_PER_PICKUP = 20000

local atmCooldown = {}
local atmBag = {}
local atmBagColShape = {}
local atmTimer = {}
local atmSerial = {}


ATMs = 
{
       {1462.159, -965.758, 26.861},
   -- { 1817.2287597656, -1406.0472412109, 13.60000038147 },
}


function onATMShapeHit2 ( element )
	if ( isElement(element) and getElementType(element) == "player"  ) then
		if ( not isPedInVehicle(element) and isPedOnGround(element) ) then
				if ( atmIsAbleToRob2(element) and not atmIsPlayerRobbing2 (element) ) then
					bindKey(element, "N", "down", atmStartRobbing2)
					drawNote('ATMRobbery', 'Pressione [N] parar roubar o banco central', element, 255, 0, 0, 5000)
				else
					drawNote('ATMRobbery', 'Você não pode roubar esse caixa no momento, você deve esperar '.. atmGetTimeOut2 ( element ) .. ' segundos', element, 255, 0, 0, 5000)
                end
		end
	end
end





function onATMShapeLeave2 ( element)
	if ( isElement(element) and getElementType(element) == "player" ) then
		if ( not isPedInVehicle(element) and isPedOnGround(element) ) then
			unbindKey(element, "N", "down", atmStartRobbing2)
			drawNote('ATMRobbery', '', element, 0, 0, 0, 1)
		end
	end
end

function atmIsAbleToRob2 ( player )
	return not isTimer(atmCooldown[player])
end

function atmIsPlayerRobbing2 ( player )
	return isElement(atmBag[player])
end

function atmGetTimeOut2 ( player )
	if isTimer ( atmCooldown[player] ) then
		local miliseconds = getTimerDetails ( atmCooldown[player] )
		return math.ceil( miliseconds / 1000 )
	else
		return false
	end
end


function atmSetTimeOut2 ( player, time )
	atmCooldown[player] = setTimer( 
	function (player) 
	atmCooldown[player] = nil 
	end, time, 1, player)
end


--[[
function atmIsAbleToRob2 ( player )
	return not isTimer(atmCooldown[player])
end

function atmIsPlayerRobbing2 ( player )
	return isElement(atmBag[player])
end

function atmGetTimeOut2 ( player )
	if isTimer ( atmCooldown[player] ) then
		local miliseconds = getTimerDetails ( atmCooldown[player] )
		return math.ceil( miliseconds / 1000 )
	else
		return false
	end
end]]--

--[[
function atmSetTimeOut2 ( player, time )
	atmCooldown[player] = setTimer( 
	function (player) 
	atmCooldown[player] = nil 
	for _, player in ipairs(getElementsByType("player")) do
	setElementData(player, "poderassaltar", false)
	end
	end, time, 1, player)
end
]]--



function atmDrawProgress2 ( player, time )
	exports.bgo_hud:drawProgressBar( 'ATMRobbery_ProgressBar', 'Progresso do Roubo', player, 255, 0, 0, time )
end

function onATMPickupHit2 ( element )
	if ( isPedInVehicle(element) ) then return end		
			
	if ( getElementData(source, "ATMRobbery.owner") == element ) then
		atmPay2(element)
		setTimer(
			function (pickup)
				destroyElement(pickup)
			end, 50, 1, source)
	else
		cancelEvent()
	end
end



local gate = createObject (1911, 1461.599609375, -964.400390625, 27, 0, 0, 180.49987792969 )

local function resetBank()
	setElementDimension(gate,0)
	--gate = createObject (2634, 1474.1, -976.90002, 27.6, 0, 0, 0 )
end

local element = {}
local doingbankrob = {}
local erbeutet = {}
local DINHEIRO = {}

local markerpos = {
	[1] = {1452.816, -952.045, 26.756},
	[2] = {1456.232, -951.811, 26.756}, 
	[3] = {1459.731, -951.795, 26.756},
	[4] = {1464.239, -951.771, 26.756},
	[5] = {1468.731, -951.771, 26.756},
}


function onATMRobberyComplete2 ( player )
		local x, y, z = getElementPosition( atmBag[player] )
		--for index = 1, ATM_PICKUPS do
			local offset = 0 --index*0.1
			local randomNumber = math.random(0.1, 0.6)

			--local pickup = createPickup(x-offset, y+randomNumber, z, 3, 1212, 1)



			--local pickup = createPickup(1476.9976806641, -980.97088623047, 26.8125, 3, 1212, 1)


			--setElementData(pickup, "ATMRobbery.owner", player)
			--addEventHandler("onPickupHit", pickup, onATMPickupHit2)

		--end

		for i = 1, #markerpos, 1 do
		element["robmarker"..i] = createMarker(markerpos[i][1], markerpos[i][2], markerpos[i][3]-0.8, "cylinder", 1.0, 0, 255, 0, 50)
		local m = element["robmarker"..i]
		addEventHandler("onMarkerHit", m, function(hitElement)
			if(getElementType(hitElement) == "player") then
				destroyElement(source)
				destroyElement(element["canta"..i])
                                setElementFrozen ( hitElement, true )
				setPedAnimation(hitElement, "bomber", "BOM_Plant_Loop", -1, true, false, false)
				toggleAllControls(hitElement, false)

				Dinheiro222 = setTimer(function()
				
				
					--DINHEIRO[hitElement] = createObject ( 1550, 0, 0, 0 )
                    --setElementCollisionsEnabled (DINHEIRO[hitElement], false)
					--attachElements ( DINHEIRO[hitElement], hitElement, 0, -0.3, 0.2 )
                    --                    setTimer(destroyElement,60000,1,DINHEIRO[hitElement])
					
					-- SICHERHEITSHINWEIS --
					setPedAnimation(hitElement)
					toggleAllControls(hitElement, true)
					atmPay2 ( hitElement )
					local geld3 = math.random(1000, 6000)
					doingbankrob[hitElement] = true
					erbeutet[hitElement] = geld3
                                        setElementFrozen ( hitElement, false )
					setTimer(function()
						doingbankrob[hitElement] = false
						erbeutet[hitElement] = 0
					end, 60000, 1)
				end, 15000, 1)
			end
		end)
end

		--for explosions = 1, 3 do
			createExplosion(x, y, z, 11)
		--end

		--destroyElement(gate) 
		setElementDimension(gate,9875)

		destroyElement(atmBag[player])
		destroyElement(atmBagColShape[player])
		atmBag[player] = nil
		atmBagColShape[player] = nil
		triggerClientEvent(player, "terminaracao", player)
		--triggerClientEvent(root, "atmstopRobbing2", root, player)

end

addEventHandler("onPlayerWasted", getRootElement(), function()
	if(doingbankrob[source] == true) then
		if(erbeutet[source]) then
			doingbankrob[source] = false
			local geld = erbeutet[source]
			local geld1 = math.random(1000, 6000)
			--takePlayerMoney( source, geld1 )
			--setElementData(source, "char:moneysujo", (getElementData(source,"char:moneysujo") or 0) - geld1)
			
			triggerEvent('btcMTA->#takePlayerItemToID', source, source, 22, true)
			if isTimer(Dinheiro222) then
            killTimer(Dinheiro222)
			end
			toggleAllControls(source, true)
			outputChatBox("Você morreu e o seu dinheiro devolvido ai banco de volta!", source, 255, 0, 0)
			exports.bgo_hud:dm("Você morreu e o seu dinheiro devolvido ai banco de volta!",source, 200, 0, 0 )
		end
	end
end)

addEventHandler("onPlayerQuit", getRootElement(), function(reason)
	if(reason ~= "Kicked") and (reason ~= "Timed out")  then
		if(doingbankrob[source] == true) then
			if(erbeutet[source]) then
				doingbankrob[source] = false
				--local geld = erbeutet[source]
					--local geld1 = math.random(5000, 10000)
							--takePlayerMoney( source, geld1 )
					if isTimer(Dinheiro222) then
                       killTimer(Dinheiro222)
				end
			end
		end
	end
end)



function atmPay2 ( player )
		geld = math.random(40000, 100000)
		--exports.bgo_hud:dm("Você recebeu "..geld.." de dinheiro sujo!",player, 200, 0, 0 )
		--setElementData(player, "char:moneysujo", (getElementData(player,"char:moneysujo") or 0) + geld )
		--triggerClientEvent(player, "TESTE2", root, "Roubo efetuado com sucesso")
		

		
		if exports.bgo_items:giveItem(player, 230, 1, geld, 0, true) then 
        local linha = math.random(1, 255 )
        exports.bgo_hud:drawNote("Sujo"..linha.."", "+ "..geld.." em blocos de dinheiro!", player, 255, 255, 255, 7000) 
		triggerClientEvent(player, "onClientPlayerGiveMoney", player, geld)
        end
		
		
		
end

       
--local zone = createColCuboid(1813.44348, -1417.28772, 11.10156, 23.285034179688, 23.098999023438, 9.8000062942505)

             local zone = createColCuboid(1450.88062, -984.68634, 25.86105, 22.559204101563, 20.396301269531, 3.9999946594238)

	
function getAlivePlayersInTeam(theTeam)
    local theTable = { }
    local players = getPlayersInTeam(theTeam)

    for i,v in pairs(players) do
        if not isPedDead(v) and exports.bgo_items:atmIsAbleToRob(v) then
            theTable[#theTable+1]=v
        end
    end

    return theTable
end

function atmStartRobbing2 ( element )
	unbindKey(element, 'N', 'down', atmStartRobbing2)
	if ( isElement(element) ) then
	
	local policiaTeam = getTeamFromName ( "Policia" )
            	local groveCount = #getAlivePlayersInTeam(policiaTeam) --countPlayersInTeam ( policiaTeam )
									if tonumber(groveCount) >= 25 then
			
			

		count = {}
		for i,v in pairs(getElementsWithinColShape(zone,"player")) do
		--if getTeamName(getPlayerTeam(v)) == "Criminals" then
			table.insert(count,v)
		--end
		end
		
		if #count < 10 then--3
		exports.bgo_hud:dm("Não há criminosos suficientes para roubar tem que ter no minimo 10 criminosos.",element, 200, 0, 0 )
		return
		end


		exports.bgo_anims:setJobAnimation(element, "BOMBER", "BOM_Plant", 2500, false, false, true, false )
		toggleAllControls(element, false)
		setTimer(toggleAllControls, 2500, 1, element, true)
		atmDrawProgress2 ( element, ATM_PROGRESS_TIME )
		
		for _, player in ipairs(getElementsByType("player")) do
		atmSetTimeOut2(player, ATM_TIMEOUT)
		end
--[[
		setTimer(function()
		resetBank()
		end , ATM_TIMEOUT, 1)]]--

		bankTimer = setTimer(resetBank, ATM_TIMEOUT, 1) 
		bankTimer2 = setTimer(setElementDimension, ATM_TIMEOUT, 1, gate,0) 
		--setElementDimension(gate,0)
		


		
		--local wantedLvl = getPlayerWantedLevel ( element )
		--setPlayerWantedLevel ( element, wantedLvl + 3 )
		
		  local x, y, z = getElementPosition ( element )
		local location = getZoneName ( x, y, z )
		local city = getZoneName ( x, y, z, true )

		for _, players in ipairs(getElementsByType("player")) do
		triggerClientEvent(players, "TESTE22", root, "Estão roubando o bgo bank")
		if getPlayerTeam(players) == getTeamFromName("Policia")  then
		exports.bgo_hud:drawNote("assalto2" .. location .. "", "[Denuncia Anônima]: Estão roubando o bgo bank proximo a base do resgate " .. location .. " " .. city, players, 255, 255, 255, 10000)
		--triggerClientEvent(players, "TESTE22", root, "Estão roubando o banco itaú!")
		end
		end

		local x, y, z = getElementPosition(element)
		atmBag [ element ] = createObject( 1654, x+0.3, y, z-0.9, -90, 0, 0)
		triggerClientEvent(root, "setObjectUnbreakable2", root, atmBag[element] )
		
		local x, y, z = getElementPosition( atmBag[element] )
		atmBagColShape [ element ] = createColSphere ( x, y, z, 2 )
		setElementData(atmBagColShape[element], "atmParent", atmBag[element])
		setElementData(atmBagColShape[element], "atmOwner", element)
		addEventHandler("onColShapeHit", atmBagColShape[element], onATMBagColShapeHit2)
		addEventHandler("onColShapeLeave", atmBagColShape[element], onATMBagColShapeLeave2)
		
		atmTimer[element] = setTimer(onATMRobberyComplete2, ATM_PROGRESS_TIME, 1, element)
		local ms = getTimerDetails(atmTimer[element])
--		triggerClientEvent(root, "bomb2", root, ms, atmBag[element], atmBagColShape[element])
		triggerClientEvent(root, "bomb2", root, ms, atmBag[element])
		else
			outputChatBox("#dc143c[AVISO]:#ffffff Para assaltar o BGO BANK precisa de 40 policiais na cidade!",element, 255, 255, 255, true)
		end
	end
end
			
function stopRobbing2 (player)
	if ( isElement(atmBag[player]) )then
		destroyElement(atmBag[player])
		destroyElement(atmBagColShape[player])
		atmBag[player] = nil
		atmBagColShape[player] = nil
	end
	if ( isTimer(atmTimer[player]) ) then
		killTimer(atmTimer[player])
		atmTimer[player] = nil
	end
	triggerClientEvent(root, "terminaracao", root)
	exports.bgo_hud:drawProgressBar( 'ATMRobbery_ProgressBar', '', player, 255, 0, 0, 1 )
	drawNote('ATMRobbery', '', player, 255, 0, 0, 1)
end

addEventHandler("onPlayerJailed", root, 
	function ()
		stopRobbing2(source)
	end
)

function onATMBagColShapeHit2 ( element )
	if getPlayerTeam(element) == getTeamFromName("Policia") then
	if ( isElement(element) and getElementType(element) == "player" ) then --and not getElementData(source, "atmOwner") and dim ) then
		if ( not isPedInVehicle(element) ) then
			bindKey(element, 'N', 'down', atmUnplanting2, source)
			drawNote('ATMRobbery', "Pressione [N] para defusar a bomba do "..getPlayerName(getElementData(source, "atmOwner")).."", element, 30, 125, 255, 5000)
		end
	end
end
end


function onATMBagColShapeLeave2 ( element)
	if ( isElement(element) and getElementType(element) == "player" and not getElementData(source, "atmOwner") and dim ) then
		unbindKey(element, 'N', 'down', atmUnplanting2)
		drawNote('ATMRobbery', '', element, 0, 0, 0, 1)
	end
end

function atmUnplanting2 ( cop, _, _, colshape )
	if ( not isElement(colshape) or getElementData(colshape, "atmIsBeingDefused") ) then
		return exports.bgo_hud:dm("Esta bomba" .. (isElement(colshape) and "já esta desarmada" or "já está sendo neutralizada!"), cop, 255, 0, 0)
	end
	local ms = getTimerDetails(atmTimer[getElementData(colshape, "atmOwner")])
		if ( ms < 10000 ) then
			unbindKey(cop, 'N', 'down', atmUnplanting2)
			exports.bgo_hud:dm("É muito tarde! Afaste-se da bomba!", cop, 255, 0, 0)
		return end
		unbindKey(cop, 'N', 'down', atmUnplanting2)
		exports.bgo_anims:setJobAnimation(cop, "BOMBER", "BOM_Plant", 7500, true, false, true, false )
		exports.bgo_hud:drawProgressBar( 'ATMRobbery_Unplanting', 'Progresso do desarme', cop, 30, 125, 255, 7500 )
		local criminal = getElementData(colshape, "atmOwner")

		setElementData(colshape, "atmIsBeingDefused", true)
		toggleAllControls(cop, false)
		setTimer(
				function ( )
					if ( isElement(cop) and not isPedDead(cop) ) then
						exports.bgo_hud:dm("O policial "..getPlayerName(cop).." Defusou sua bomba.", criminal, 255, 0, 0)
						exports.bgo_hud:dm("Você desativou com sucesso a bomba do "..getPlayerName(criminal)..".", cop, 255, 0, 0)
						
								for _, player in ipairs(getElementsByType("player")) do
						triggerClientEvent(player, "TESTE22", root, "Assalto ao banco Central falhou")
						end
		
		
						stopRobbing2(criminal)	
						--givePlayerMoney(cop, 2500)
						--triggerClientEvent(source, "onClientPlayerGiveMoney2", source, 2500)
						
						
						toggleAllControls(cop, true)
					end
					if ( isElement(colshape) ) then
						setElementData(colshape, "atmIsBeingDefused", false)
					end
				end, 7500, 1)
end


function drawNote(id, text, player, r, g, b, time)
	exports.bgo_hud:drawNote(id, text, player, r, g, b, time)
end

addEventHandler("onResourceStart", resourceRoot, function()
	for i,v in ipairs(ATMs) do
		local colshape = createMarker(v[1], v[2], v[3]-1, "cylinder", 2, 25, 255, 25, 150)
		atmBlip = createBlip ( v[1], v[2], v[3], 36, 1, 0, 0, 0, 0, 0, 300 )
		addEventHandler("onMarkerHit", colshape, onATMShapeHit2)
		addEventHandler("onMarkerLeave", colshape, onATMShapeLeave2)
	end
end)

addEventHandler("onPlayerWasted", root,
	function ()
		if ( atmIsPlayerRobbing2(source) ) then
			stopRobbing2(source)
			
			for _, player in ipairs(getElementsByType("player")) do
			triggerClientEvent(player, "TESTE22", root, "Assalto ao banco Central falhou")
			end
						
		end
	end
)

addEventHandler ("onPlayerArrested", root, 
	function ()
		if ( atmIsPlayerRobbing2(source) ) then
			stopRobbing2(source)
		end
	end
)

addEventHandler("onPlayerGetJob", root,
	function ()
		unbindKey(source, "N", "down", atmStartRobbing2)
		drawNote('ATMRobbery', '', source, 0, 0, 0, 1)
	end
)

addEventHandler("onPlayerGetJob", root,
	function (job, new)
		if ( job and new ~= "Criminal" and atmIsPlayerRobbing2(source)) then
			stopRobbing2(source)
		end
	end
)

addEventHandler("onResourceStop", resourceRoot, 
	function ()
		for index, players in ipairs ( getElementsByType("player") ) do
			if ( atmIsPlayerRobbing2(players) ) then
				stopRobbing2(players)
			end
		end
	end
)

addEventHandler("onPlayerQuit", root,
	function ()
		if ( atmIsPlayerRobbing2(source) ) then
			stopRobbing2(source)
			
			for _, player in ipairs(getElementsByType("player")) do
			triggerClientEvent(player, "TESTE22", root, "Assalto ao banco Central falhou")
			end
			
		end
	end
)


function jailZoneLeave ( thePlayer )
   --if getElementType ( thePlayer ) == "player" then 
   		if ( atmIsPlayerRobbing2(thePlayer) ) then	
		for _, player in ipairs(getElementsByType("player")) do
		stopRobbing2(player)	
		triggerClientEvent(player, "TESTE22", root, "Assalto ao banco Central falhou")
		--end
	end
   end
end
addEventHandler ( "onColShapeLeave", zone, jailZoneLeave )



		
		
addEventHandler("onPlayerQuit", root,
	function ()
		if ( atmGetTimeOut2(source) ) then
			atmSerial[getPlayerSerial(source)] = atmGetTimeOut2(source)
		end
	end
)

addEventHandler("onPlayerQuit", root,
	function ()
		for _, pickups in ipairs ( getElementsByType("pickup") ) do
			if ( getElementData(pickups, "ATMRobbery.owner") == source ) then
				removeEventHandler("onPickupHit", pickups, onATMPickupHit2)
				destroyElement(pickups)
			end
		end
	end
)

addEventHandler("onPlayerArrested", root,
	function ()
		for _, pickups in ipairs ( getElementsByType("pickup") ) do
			if ( getElementData(pickups, "ATMRobbery.owner") == source ) then
				removeEventHandler("onPickupHit", pickups, onATMPickupHit2)
				destroyElement(pickups)
			end
		end
	end
)

addEventHandler("onPlayerWasted", root,
	function ()
		for _, pickups in ipairs ( getElementsByType("pickup") ) do
			if ( getElementData(pickups, "ATMRobbery.owner") == source ) then
				removeEventHandler("onPickupHit", pickups, onATMPickupHit2)
				destroyElement(pickups)
			end
		end
	end
)

addEventHandler("onPlayerJoin", root,
	function ()
		for serial, cooldown in pairs ( atmSerial ) do
			if ( getPlayerSerial(source) == serial ) then
				atmSetTimeOut2(source, cooldown*1000)
				atmSerial[serial] = nil
			end
		end
	end
)
   