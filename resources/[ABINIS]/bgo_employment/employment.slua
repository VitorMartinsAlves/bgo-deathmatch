----------------------------------------->>
-- : Grand Theft International
-- Date: 03 Dec 2013
-- Resource: employment/employment.slua
-- Type: Server Side
-- Author: JT Pennington (JTPenn)
----------------------------------------->>

UNEMPLOYED_TEAM = "General Population"	-- Unemployed Team
ODR, ODG, ODB = 255, 255, 255			-- Off-Duty Color

addEvent("onPlayerGetJob", true)
addEvent("onPlayerQuitJob", true)
addEvent("onPlayerJobDivisionChange", true)

-- Job Functions
----------------->>


function getPlayerJob(player, isWorking, isValid)
	if (not isElement(player)) then return false end
	local job = getElementData(player, "job")
	if (job == "" or not job) then return false end

	--local JobInfo = exports.employTable:getJobsTable()
	if (isValid and not JobInfo[job]) then return false end

	if (isWorking) then
		local working = getElementData(player, "isWorking")
		if (working == 1) then
			return job
		else
			return false
		end
	end

	return job
end


function setPlayerJob(player, job, division, skinID, no_event)
	if (not isElement(player)) then return end
	local account = getPlayerAccount(player)
	local oldJob = getElementData(player, "job") or false
	if (oldJob == "") then oldJob = false end

	if (tonumber(skinID)) then
	if getElementType ( player ) == "player" then
		local genero = getElementData(player, "char:genero")
		if genero == "homem" then 
		setElementModel(player, tonumber(skinID)) 
		end
		--exports.accounts:SAD(account, "jobskin", skinID)
	end
	end

	if (job == division) then division = nil end
	exports.bgo_hud:drawMissionText("job", job..(division and ", "..division or ""), player, r, g, b)
	playSoundFrontEnd(player, 11)

	--exports.accounts:SAD(account, "job", job)
	setElementData(player, "job", job)
	--exports.accounts:SAD(account, "isWorking", 1)
	setElementData(player, "isWorking", 1)
	local old_division = getPlayerJobDivision(player)
	setPlayerJobDivision(player, division or job)

	if (no_event) then return true end
	triggerEvent("onPlayerQuitJob", player, oldJob, true, old_division or false)
	triggerClientEvent(player, "onClientPlayerQuitJob", player, oldJob, true, old_division or false)
	triggerEvent("onPlayerGetJob", player, job, true, division or false)
	triggerClientEvent(player, "onClientPlayerGetJob", player, job, true, division or false)
	return true
end

-- Divisions
------------->>

function getPlayerJobDivision(player)
	if (not isElement(player)) then return false end
	local division = getElementData(player, "division")
	if (division == "" or not division) then return false end
	return division
end

function setPlayerJobDivision(player, division)
	triggerEvent("onPlayerJobDivisionChange", player, getPlayerJobDivision(player), division)
	setElementData(player, "division", division)
	local account = getPlayerAccount(player)
	--exports.accounts:SAD(account, "division", division)
	return true
end

function isJobDivisionUnlocked(player, job, division)
	local JobInfo = exports.employTable:getJobsTable()
	if (JobInfo[job]) then return false end

	local level = getPlayerJobLevel(player, job)
	if (not level) then return false end

	if (JobInfo[job].divisions) then
		for i,div in ipairs(JobInfo[job].divisions) do
			if (division == div[1] and level < div[2]) then
				return false
			end
		end
	end
	return true
end

-- Uniform
----------->>

function setPlayerJobUniform(player, skinID)
	setElementModel(player, skinID)
	local account = getPlayerAccount(player)
	--exports.accounts:SAD(account, "jobskin", skinID)
	return true
end

-- End Shift and Resign
------------------------>>

function togglePlayerShift(player)
	if (not isElement(player)) then return false end
		
	local account = getPlayerAccount(player)
	local job = getPlayerJob(player)
	if (getPlayerJob(player, true)) then
			-- End Shift
		--local skin = --exports.accounts:GAD(account, "skin")
		--if (skin) then
				setPedModel(player, 0)
		--else
		--			--exports.accounts:SAD(account, "skin", getElementModel(player))
		--end
		local r,g,b = 255, 255, 255
		exports.bgo_hud:dm("Você terminou seu turno como um "..job, player, r, g, b)
		--exports.accounts:SAD(account, "isWorking", 0)
		setElementData(player, "isWorking", 0)
		local division = getPlayerJobDivision(player)

		triggerEvent("onPlayerQuitJob", player, job, false, division)
		triggerClientEvent(player, "onClientPlayerQuitJob", player, job, false, division)
		return false
	else
			-- Start Shift
		--local skin = --exports.accounts:GAD(account, "jobskin")
		--if (skin) then
			setElementModel(player, 0)
		--end
		--local team = getPlayerTeam(player)
		local r,g,b = 255, 255, 255 --getTeamColor(team)
		--exports.blips:setPlayerNameColor(player, r, g, b)
		exports.bgo_hud:dm("Você retornou ao seu trabalho como "..job, player, r, g, b)

		--exports.accounts:SAD(account, "isWorking", 1)
		setElementData(player, "isWorking", 1)
		local division = getPlayerJobDivision(player)

		triggerEvent("onPlayerGetJob", player, job, false, division)
		triggerClientEvent(player, "onClientPlayerGetJob", player, job, false, division)
		return true
	end
end

function resign(player, hideMessage) --, ignore_event)
	if (not isElement(player)) then return false end
	local account = getPlayerAccount(player)
	local job = getElementData(player, "job")
	--local skin = --exports.accounts:GAD(account, "skin")

	--if (not skin) then
		--repeat until
		setElementModel(player, 0)
		--exports.accounts:SAD(account, "skin", getElementModel(player))
	--else
	--	setElementModel(player, skin)
	--end

	if (not hideMessage) then
		exports.bgo_hud:dm("Você se demitiu do seu trabalho como "..job, player, 255, 255, 255)
	end

	--exports.accounts:SAD(account, "job", "Desempregado")
	setElementData(player, "job", "Desempregado")
	--exports.accounts:SAD(account, "isWorking", 0)
	setElementData(player, "isWorking", 0)
	local division = getPlayerJobDivision(player)
	setPlayerJobDivision(player)

	--if (not ignore_event) then
		triggerEvent("onPlayerQuitJob", player, job, true, division)
		triggerClientEvent(player, "onClientPlayerQuitJob", player, job, true, division)
	--end
	return true
end

-- Save Job Data
----------------->>
--[[
function restoreJobData(_, account)
	if (isGuestAccount(account)) then return end
	local job = --exports.accounts:GAD(account, "job") or ""
	setElementData(source, "job", job)

	local isWorking = --exports.accounts:GAD(account, "isWorking") or 0
	setElementData(source, "isWorking", isWorking)

	local division = --exports.accounts:GAD(account, "division")
	setElementData(source, "division", division)

	if (isWorking == 1) then
		local jobskin = --exports.accounts:GAD(account, "jobskin")
		if (jobskin) then
			setTimer(setElementModel, 500, 1, source, jobskin)
		end
		triggerEvent("onPlayerGetJob", source, job, true, division)
		triggerClientEvent(source, "onClientPlayerGetJob", source, job, true, division)
	end
end
addEventHandler("onPlayerLogin", root, restoreJobData)]]--




function givePlayerJobMoney(player, job, amount)
	local Ranks = exports.employTable:getRanks()
	if (not isElement(player) or not Ranks[job] or type(amount) ~= "number") then return false end
	local account = getPlayerAccount(player)
	if (isGuestAccount(account)) then return false end
	local bonus

	
	givePlayerMoney(player, amount)
	if (not money[player]) then money[player] = {job, 0} end
	money[player][2] = money[player][2] + (not bonus and amount or math.floor(amount * 1.1))
	
	exports.bgo_hud:drawNote("Money"..math.random(1,1000), "+ $"..exports.util:tocomma(not bonus and amount or math.floor(amount * 1.1)), player, 25, 255, 25, 7500)
	return true
end


-- Utilities
------------->>

function isPlayerNearCriminal(player)
	local x1,y1,z1 = getElementPosition(player)
	for k,crim in ipairs(getElementsByType("player")) do
		local x2,y2,z2 = getElementPosition(crim)
		if (getDistanceBetweenPoints3D(x1,y1,z1, x2,y2,z2) <= 75) then
			if (exports.criminals:isCriminal(crim)) then return true end
		end
	end
	return false
end
